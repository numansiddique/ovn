# ovn-northd-ddlog Design Notes

`ovn-northd-ddlog` is a port of the OVN northd controller to
[DDlog](https://github.com/ryzhyk/differential-datalog).  This
document describes its design and usage.

## Other resources

- [DDlog tutorial](https://github.com/ryzhyk/differential-datalog)
- [DDlog for OVN developers tutorial](https://www.youtube.com/watch?v=P-1VwZNNpAc&t=2098s)

## Building and using ovn-northd-ddlog

### Building

To OVS and OVN with `ovn-northd-ddlog` enabled:

- Make sure that you have the latest version of DDlog installed.  Follow
  [DDlog installation instructions](https://github.com/ryzhyk/differential-datalog#installing-from-sources)
  to install DDlog from source or binary release.

- Make sure that you are on the `ddlog` branch of the `ovs` repository.

- Configure OVS with `ovn-north-ddlog` enabled:
  ```
  ./configure --with-ddlog=<path to differential-datalog directory>/lib
  ```

- Run `make` as you normally would to build OVS and OVN.  (Unfortunately
  this takes much longer than normal OVS builds due to the Rust compiler
  being slow, typically 10-15 minutes on a laptop. We are working to
  improve build times).

### Switching between DDlog and C versions of `northd`

If you configured OVS with `ovn-northd-ddlog` enabled, OVN will start with
`ovn-northd-ddlog` by default.  You can fall back to using the C version
by editing the `ovn/northd/ovn-northd` script, uncommenting the `ovn-northd`
command and commenting out the `ovn-northd-ddlog`, and restarting OVN.

### Upgrading DDlog

The DDlog language and libraries are still evolving rapidly, and you may
occasionally have to update to the latest version that resolves a bug
or adds a feature needed by `ovn-northd-ddlog`.  To do so, pull
the latest `master` branch of DDlog and run `stack install` (or simply
download and unzip the latest binary release).

In the OVS directory, run `make clean` to force recompilation of
`ovn-northd-ddlog`.

### Debugging and profiling

See the [debugging guide](./debugging.md) for tips on debugging and
profiling `ovn-northd-ddlog`.

## Overview of `ovn-northd-ddlog` source code

The `ovn-northd-ddlog` implementation consists of the following source files
in the `ovn/northd` directory.

- `ovn.dl` and `ovn.rs` - DDlog declarations of various OVN and OVS-specific
  datatypes and DDlog bindings for C functions exported by `libovn` and
  `libopenvswitch` static libraries.

- `lswitch.dl` - computes intermediate relations for working with logical
  switches and ports.

- `lrouter.dl` - computes intermediate relations for working with logical
  routers and logical router ports.

- `ipam.dl` - IP address management (IPAM) and MAC address management (MACAM)
  logic

- `helpers.dl` - several useful helper relations used by multiple other modules.

- `OVN_Northbound.dl`, `OVN_Southbound.dl` - files autogenerated by the
  `ovsdb2ddlog` tool from `ovn/ovn-nb.ovsschema` and `ovn/ovn-sb.ovsschema`
  respectively, containing DDlog declaration of OVSDB tables and some additional
  plumbing to compute deltas between input and output relations.

- `ovn_northd.dl` - the main DDlog program that computes all output relations,
  including logical flows.

- `ovn-northd-ddlog.c` - the C program that provides the `main()` function for
  `ovn-northd-ddlog`.  The program subscribes to updates from Northbound and
  Southbound databases.  The main loop of the program receives OVSDB update
  notifications in the OVSDB JSON format and passes them directly to the DDlog
  API.  It then extracts changes to Northbound and Southbound tables computed
  by DDlog, also in the JSON format and sends them them as commands to OVSDB.

## TODO: detailed description of each module
